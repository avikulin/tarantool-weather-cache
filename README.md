# Пример реализации Read-Aside кэша на Tarantool

Функциональное приложение на *Lua*, созданное по шаблону *Tarantool Cartridge*.

Приложение выполняет запросы к API-сервису *OpenMeteo*, кэшируя полученную информацию.

При поступлении нового запроса, приложение выполняет следующий порядок дейтвий:

1. Проверяет состояние кэша
   1. если в кэше присутствует запрашиваемая информацию - ответ выдается из кэша
   2. если в кэше информацию отсутствует, то выполняется запрос к стороннему API, который сохраняется в кэше перед передачей клиенту.
2. Обрабатывает *evict*-политики кэша в соответствии с конфигурацией ([см. ниже](#параметры-управления-состояние-кэша))
3. Передает ответ пользователю, дополняя его служебными заголовками ([см. ниже](#использование)), которые отображают состояние кэша в разрезе данной сущности.

## Развертывание и запуск

Сборка и запуск приложения выполняется стандартными средствами *cartridge-cli* в соответствии со следующим примером:

```bash
cartridge build
cartridge start -d
cartridge replicasets setup --bootstrap-vshard
```
После первоначального развертывания приложения, в него необходимо загрузить параметры настройки ролей.
Это выполняется из основного каталога приложения с использованием следующей команды:

```bash
curl -v 'localhost:8081/admin/config' -X PUT --data-binary @cfg/cluster-config.yml
```

## Параметры конфигурирования

Конфигурация состоит из 2-х основных разделов:

* Параметры подключения к *Open Meteo API*. 
* Параметры управления состояние кэша.  

> Функциональность обращения *<Open Meteo API>() включена в роль *router*, а функциональность управления кэшем включена в роль *cache*, поэтому данные разделы конфигурации автоматически валидируются при активации соответствующих ролей на узлах.

### Параметры подключения к Open Meteo API

Конфигурация работы с *Open Meteo API* состоит из следующих параметров:
<a id="open-meteo-api"></a>
```yml
weather-provider:
  uri: https://api.open-meteo.com/v1/forecast   # Основной URI отправки запросов
  x_coord_param: longitude                      # Название параметра, в котором передается геогр. долгота
  y_coord_param: latitude                       # Название параметра, в котором передается геогр. широта
  actuality_options:                            # Возможные типы обрабатываемых запросов
    - current                                   #   - получение данных на текущий момент
    - hourly                                    #   - получение прогноза на ближайший час
    - minutely_15                               #   - получение данных на ближайшие 15 минут
  query_options:                                # Состав данных, которые мы хотим получить по запросу любого типа
    - temperature_2m                            #   - температура по Цельсию на высоте 2 м над землей
    - wind_speed_10m                            #   - скорость ветра на высоте 10 м над землей
    - relative_humidity_2m                      #   - относительная влажность воздуха на высоте 2 м над землей
```

> При выполнении запроса к приложению, оно ожидает, что первый PATH-параметр будет соответствовать одному из значений <actuality_options>, а параметры <x_coord_param>, <y_coord_param> и <query_options> будут переданы в QUERY-параметрах запроса.

### Параметры управления состояние кэша

Конфигурация управления внутренним кэшем данных состоит из следующих параметров:

```yml
cache-dal:
  size: 10                      # Передел роста размера кэша, после которого начинается вытеснение элементов 
  time-to-live: 30              # Макс. время актуальности элемента в кэше (секунды), после истечения которого элемент вытесняется
  eviction_strategy: lru        # Политика отбора элементов для вытеснения
```

Приложение поддерживает следующие возможные политики вытеснения:

1. **FIFO** *(first-in-first-out)*. Первым будет вытеснен элемент, который был добавлен в кэш хронологически раньше.
2. **LRU** *(least reasently used)*. Первым будет вытеснен элемент, к которому было наименьшее *количество* обращений.
3. **LRA** *(least reasently accessed)*. Первым будет вытеснен элемент, к которому наибольшее время не было обращений.

## Использование

Приложение ожидает *GET*-запрос к ноде <router> по основному порту <http_port>, указанному в конфигурационном файле [instances.yml](instances.yml)
Запрос должен иметь следующий формат:

```url
http://localhost:8081/weather/current?latitude=55.752004&longitude=37.617734
```
1. **PATH-параметр "/weather/:actuality"**. Определяет тип актуальности прогноза и должен лексикографически соответствовать одному из значений конфигурации <weather-provider/actuality_options>.
2. **QUERY-параметр "latitude" геграфической долготы**. Имя параметра должно лексикографически соответствовать параметру "weather-provider/x_coord_param".
3. **QUERY-параметр "longitude" геграфической широты**. Имя параметра должно лексикографически соответствовать параметру "weather-provider/y_coord_param".

Ответы сервиса дополняются рядом специальных заголовков:

1. **x-cache-hit-rate**. Соответствует количеству зарегистрированных обращений к данному элементу за все время пребывания в кэше.
2. **x-cache-ttl**. Соответствует оставшемуся времени жизни (секунды) данного элемента до вытеснения из кэша.
3. **x-cached-data**. Соответствует источнику получения сведений: *true* означает получение информации из кэша, а *false* - получение информации от *Open Meteo API*.

Примеры тестовых запросов для каждой политики управления состоянием кэша приведены в следующих файлах:

1. [FIFO](test/integration/curl/fifo_test.sh) *(first-in-first-out)*.
2. [LRU](test/integration/curl/lru_test.sh) *(least reasently used)*.
3. [LRA](test/integration/curl/lra_test.sh) *(least reasently accessed)*.


> Полное описание конфигурационных параметров, определяющих работу внешнего API приведено [по ссылке](#параметры-подключения-к-open-meteo-api) 
